<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Smart EMS: Final Masterpiece V3</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; background: #263238; overflow: hidden; }
        .full-screen { width: 100%; height: 100vh; position: absolute; top: 0; left: 0; transition: 0.3s; }
        
        /* [1] êµ¬ê¸‰ì°¨ í™”ë©´ */
        #view-ems { background: #eceff1; z-index: 10; display: block; }
        #map { width: 100%; height: 100%; }

        .ems-sidebar {
            position: absolute; top: 20px; left: 20px; bottom: 20px; z-index: 20;
            width: 400px; background: white; border-radius: 12px;
            box-shadow: 5px 0 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden;
        }

        /* ëª¨ë‹ˆí„° */
        .monitor-screen { background: #000; padding: 15px; color: #0f0; flex-shrink: 0; border-bottom: 4px solid #333; }
        .mon-header { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 5px; }
        
        .ecg-area { width: 100%; height: 60px; background: #111; margin-bottom: 10px; border: 1px solid #333; position: relative; overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        
        #arrhythmia-alert { position: absolute; top: 5px; right: 5px; font-size: 10px; background: #d32f2f; color: white; padding: 2px 5px; display: none; animation: blink-fast 0.5s infinite; }

        .val-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center; }
        .val-box { background: #111; padding: 5px 0; border-radius: 5px; border: 1px solid #333; }
        .val-label { font-size: 10px; color: #aaa; display: block; margin-bottom: 2px;}
        .val-num { font-size: 18px; font-weight: bold; font-family: 'Courier New', monospace; }
        
        .c-hr { color: #00e676; } .c-spo2 { color: #2979ff; } .c-bp { color: #ff1744; }
        .c-rr { color: #ffeb3b; } .c-bt { color: #e040fb; } .c-glu { color: #00bcd4; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .sidebar-body { flex-grow: 1; overflow-y: auto; padding: 15px; background: #f5f5f5; }
        .section-header { font-size: 13px; font-weight: bold; color: #37474f; margin: 15px 0 5px 0; border-left: 3px solid #d32f2f; padding-left: 6px; }
        .section-header:first-child { margin-top: 0; }

        .input-card { background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; }
        .input-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .input-group { flex: 1; }
        .input-group label { display: block; font-size: 10px; color: #666; margin-bottom: 2px; }
        .live-input { background-color: #e3f2fd; color: #0d47a1; font-weight: bold; text-align: center; }
        input, select, textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; box-sizing: border-box; }
        textarea { height: 40px; resize: none; width: 100%; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; padding: 5px; font-family: 'Pretendard';}

        /* AI ë°•ìŠ¤ */
        .ai-box {
            background: #263238; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px;
            border-left: 5px solid #ff9800; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .ai-title { font-size: 11px; color: #aaa; font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .ai-diagnosis { font-size: 16px; font-weight: bold; color: #ffeb3b; margin-bottom: 5px; line-height: 1.3; }
        .ai-sub { font-size: 11px; color: #cfd8dc; font-style: italic; }
        
        .ai-safe { border-left-color: #2196f3; }
        .ai-normal { border-left-color: #00e676; }
        .ai-warn { border-left-color: #ff9800; }
        .ai-danger { border-left-color: #ff1744; animation: pulse-border 1s infinite; }
        .ai-critical { border-left-color: #d50000; background: #3e0000; animation: flash-bg 0.5s infinite; }

        /* ë¦¬ìŠ¤íŠ¸ */
        .h-list { margin-top: 5px; }
        .h-card { 
            background: white; padding: 10px; margin-bottom: 6px; border-radius: 6px;
            border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .h-card.verified { border-left: 5px solid #2196f3; background: #e3f2fd; }
        .h-card.accepted { border-left: 5px solid #2e7d32; background: #e8f5e9; }
        .h-card.rejected { border-left: 4px solid #c62828; background: #ffebee; opacity: 0.7; }

        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; color: white; display: inline-block; min-width: 50px; text-align: center; }
        .bg-ver { background: #1565c0; margin-right: 3px; font-weight: bold; }
        .bg-wait { background: #ff9800; animation: blink 1s infinite; }
        .bg-reject { background: #c62828; }
        .bg-ok { background: #2e7d32; }

        .btn-main { width: 100%; padding: 10px; background: #37474f; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 13px; }
        .btn-send { background: #d32f2f; }
        .btn-select { background: #2e7d32; border:none; color:white; padding:4px 8px; border-radius:12px; cursor:pointer; font-size:10px; animation: pulse 1s infinite; }

        /* [2] ë³‘ì› ê´€ì œ */
        #view-hos { background: #eceff1; z-index: 100; display: none; padding: 30px; box-sizing: border-box; overflow-y: auto; }
        .hos-layout { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; height: 100%; }
        .hos-monitor-panel { flex: 1; background: #000; border-radius: 15px; padding: 20px; color: #0f0; display: flex; flex-direction: column; }
        .hos-list-panel { flex: 1; overflow-y: auto; }
        .hos-card-item { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid #ddd; }
        .hos-card-item.wait { border-top-color: #ff9800; }
        .hos-card-item.ok { border-top-color: #2e7d32; opacity: 0.5; }
        .hos-card-item.no { border-top-color: #c62828; opacity: 0.5; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn-act { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
        .act-yes { background: #2e7d32; } .act-no { background: #757575; }

        .hos-ai-display { margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .hos-ai-diagnosis { font-size: 22px; font-weight: bold; color: #ffeb3b; }

        /* ëª¨ë‹¬ */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; text-align: center; z-index: 2001; width: 320px; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        @keyframes blink-fast { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 23, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0); } }
        @keyframes flash-bg { 0% { background-color: #3e0000; } 50% { background-color: #580000; } 100% { background-color: #3e0000; } }
    </style>
</head>
<body>

    <div id="view-ems" class="full-screen">
        
        <div class="ems-sidebar">
            
            <div class="monitor-screen">
                <div class="mon-header">
                    <span>ğŸš‘ PRO VITAL MONITOR</span>
                    <span style="color:red; animation:blink 1s infinite;">â— LIVE REC</span>
                </div>
                <div class="ecg-area">
                    <div id="arrhythmia-alert">âš ï¸ ARRHYTHMIA DETECTED</div>
                    <canvas id="ecg-canvas-1"></canvas>
                </div>
                <div class="val-grid">
                    <div class="val-box"><span class="val-label">HR</span><span class="val-num c-hr" id="m-hr">--</span></div>
                    <div class="val-box"><span class="val-label">SpO2</span><span class="val-num c-spo2" id="m-spo2">--</span></div>
                    <div class="val-box"><span class="val-label">NIBP</span><span class="val-num c-bp" id="m-bp">--</span></div>
                    <div class="val-box" style="margin-top:5px;"><span class="val-label">RR</span><span class="val-num c-rr" id="m-rr">--</span></div>
                    <div class="val-box" style="margin-top:5px;"><span class="val-label">TEMP</span><span class="val-num c-bt" id="m-bt">--</span></div>
                    <div class="val-box" style="margin-top:5px;"><span class="val-label">GLU</span><span class="val-num c-glu" id="m-glu">--</span></div>
                </div>
            </div>

            <div class="sidebar-body">
                
                <div class="ai-box ai-normal" id="ai-box-ems">
                    <div class="ai-title">
                        <span>ğŸ¤– AI DIAGNOSIS (v2.4)</span>
                        <span id="ai-conf">ì‹ ë¢°ë„ 98%</span>
                    </div>
                    <div class="ai-diagnosis" id="ai-diag-text">ì •ìƒ ë™ë¦¬ë“¬</div>
                    <div class="ai-sub" id="ai-action-text">íŠ¹ì´ ì†Œê²¬ ì—†ìŒ</div>
                </div>

                <div class="section-header">1. í™˜ì ì •ë³´ ì…ë ¥ (Manual Input)</div>
                <div class="input-card">
                    <div class="input-row">
                        <div class="input-group" style="flex:1;"><label>ë‚˜ì´</label><input id="p-age" type="number" value="52"></div>
                        <div class="input-group" style="flex:1;"><label>ì„±ë³„</label><select id="p-gender"><option>ë‚¨(M)</option><option>ì—¬(F)</option></select></div>
                    </div>
                    <div class="input-row">
                        <div class="input-group" style="flex:1;">
                            <label>ì‚¬ê³ /ë°œë³‘ ê²½ìœ„</label>
                            <input id="p-desc" value="ìš´ì „ ì¤‘ ê°‘ì‘ìŠ¤ëŸ° í‰í†µ í˜¸ì†Œ">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group" style="flex:2;"><label>ì§„ë‹¨ì½”ë“œ(ICD)</label><input id="p-icd" value="I21.9"></div>
                        <div class="input-group" style="flex:3;">
                            <label>ì¤‘ì¦ë„(KTAS)</label>
                            <select id="p-ktas" onchange="checkDeterioration()">
                                <option value="1">Lv.1 ì†Œìƒ (ì‹¬ì •ì§€/ë¬´í˜¸í¡)</option>
                                <option value="2">Lv.2 ê¸´ê¸‰ (ë‡Œì¶œí˜ˆ/ì‹¬ê·¼ê²½ìƒ‰)</option>
                                <option value="3" selected>Lv.3 ì‘ê¸‰ (ê³¨ì ˆ/ë³µí†µ)</option>
                                <option value="4">Lv.4 ì¤€ì‘ê¸‰ (ì—´ìƒ/ë‘ë“œëŸ¬ê¸°)</option>
                                <option value="5">Lv.5 ë¹„ì‘ê¸‰ (ë‹¨ìˆœì²˜ì¹˜)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="input-group"><label>ì˜ì‹(AVPU)</label><select id="p-avpu"><option>Alert</option><option>Voice</option><option>Pain</option><option>Unresponsive</option></select></div>
                        <div class="input-group"><label>í†µì¦(NRS)</label><select id="p-pain"><option>3</option><option>5</option><option>8</option><option>10</option></select></div>
                    </div>
                    <div class="input-row">
                         <div class="input-group"><label>êµ¬ê¸‰ëŒ€ì› ì†Œê²¬</label><textarea id="p-note">ì‹ì€ë•€, í˜¸í¡ê³¤ë€ ê´€ì°°ë¨.</textarea></div>
                    </div>
                    
                    <div style="font-size:10px; color:#d32f2f; margin-top:5px;">â–¼ ì„¼ì„œ ë°ì´í„° (ìë™ ìˆ˜ì§‘)</div>
                    <div class="input-row">
                        <div class="input-group"><label>HR</label><input type="text" id="in-hr" class="live-input" readonly></div>
                        <div class="input-group"><label>SpO2</label><input type="text" id="in-spo2" class="live-input" readonly></div>
                        <div class="input-group"><label>BP</label><input type="text" id="in-bp" class="live-input" readonly></div>
                    </div>
                </div>

                <div class="section-header">2. ì´ì†¡ ë³‘ì› ì„ ì •</div>
                <button class="btn-main" onclick="searchHospitals()">Step 1. ì£¼ë³€ ì‘ê¸‰ì‹¤ ê²€ìƒ‰ (í•„í„°ë§)</button>
                <button class="btn-main btn-send" id="btn-send" style="display:none;" onclick="confirmAndSend()">Step 2. ë°ì´í„° ì „ì†¡ ë° ìˆ˜ìš© ìš”ì²­ ğŸ“¡</button>

                <div class="h-list" id="ems-list">
                    <div style="text-align:center; color:#999; font-size:11px; padding:15px;">
                        [ê²€ìƒ‰] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´<br>ì‘ê¸‰ì‹¤ ë³´ìœ  ë³‘ì›ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>

        <div class="overlay" id="overlay"></div>
        <div class="modal" id="final-modal">
            <div style="font-size: 50px;">ğŸš</div>
            <h2 style="color:#2e7d32; margin:10px 0;">ì´ì†¡ í™•ì •</h2>
            <p id="final-msg">ë³‘ì›ìœ¼ë¡œ ì¶œë°œí•©ë‹ˆë‹¤.</p>
            <button class="btn-main" style="background:#fee500; color:black;" id="navi-btn">ğŸš¨ ì‹¤ì‹œê°„ ê¸¸ì•ˆë‚´ ì‹œì‘</button>
            <button class="btn-main" style="background:#ddd; color:#333; margin-top:5px;" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <div id="map"></div>
    </div>


    <div id="view-hos" class="full-screen">
        <div class="hos-layout">
            
            <div class="hos-monitor-panel">
                <div style="margin-bottom:20px; font-size:18px; font-weight:bold;">ğŸ¥ í†µí•© ê´€ì œ ìƒí™©ì‹¤</div>
                
                <div style="flex:1; border:1px solid #333; background:#111; border-radius:10px; margin-bottom:20px; position:relative;">
                    <canvas id="ecg-canvas-2" style="width:100%; height:100%; display:block;"></canvas>
                </div>
                
                <div class="val-grid" style="margin-bottom:20px;">
                    <div class="val-box"><span class="val-label">HR</span><span class="val-num c-hr" id="hos-hr">--</span></div>
                    <div class="val-box"><span class="val-label">SpO2</span><span class="val-num c-spo2" id="hos-spo2">--</span></div>
                    <div class="val-box"><span class="val-label">NIBP</span><span class="val-num c-bp" id="hos-bp">--</span></div>
                    <div class="val-box" style="margin-top:5px;"><span class="val-label">RR</span><span class="val-num c-rr" id="hos-rr">--</span></div>
                    <div class="val-box" style="margin-top:5px;"><span class="val-label">TEMP</span><span class="val-num c-bt" id="hos-bt">--</span></div>
                    <div class="val-box" style="margin-top:5px;"><span class="val-label">GLU</span><span class="val-num c-glu" id="hos-glu">--</span></div>
                </div>

                <div style="background:#222; padding:15px; border-radius:10px;">
                    <div style="color:#aaa; font-size:12px; margin-bottom:8px;">ğŸ“‹ ìˆ˜ì‹ ëœ í™˜ì ì •ë³´</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:13px; color:white;">
                        <div>ë‚˜ì´/ì„±ë³„: <b id="hos-age-sex" style="color:#ff9800;">-</b></div>
                        <div>KTAS: <b id="hos-ktas" style="color:#ff5722;">-</b></div>
                        <div>ì˜ì‹: <b id="hos-avpu">-</b></div>
                        <div>í†µì¦: <b id="hos-pain">-</b></div>
                        <div style="grid-column: span 2;">ì‚¬ê³ ê²½ìœ„: <b id="hos-desc">-</b></div>
                        <div style="grid-column: span 2;">ì§„ë‹¨ì½”ë“œ: <b id="hos-icd" style="color:#00bcd4;">-</b></div>
                        <div style="grid-column: span 2; border-top:1px solid #444; padding-top:5px;">
                            <span style="color:#aaa;">êµ¬ê¸‰ëŒ€ì› ì†Œê²¬:</span><br>
                            <span id="hos-note" style="font-style:italic;">-</span>
                        </div>
                    </div>
                    <div class="hos-ai-display">
                        <div style="color:#aaa; font-size:12px; margin-bottom:5px;">ğŸ¤– AI ì˜ˆì¸¡ ì§„ë‹¨ (Real-time)</div>
                        <div class="hos-ai-diagnosis" id="hos-ai-text">Loading...</div>
                    </div>
                </div>

                <button class="btn-main" style="background:#333; margin-top:auto;" onclick="backToEms()">ğŸ’¾ ì €ì¥ ë° êµ¬ê¸‰ì°¨ ë³µê·€</button>
            </div>

            <div class="hos-list-panel">
                <div style="background:white; padding:20px; border-radius:15px; min-height:100%;">
                    <h3 style="margin-top:0; color:#37474f;">ì‘ë‹µ ì‹œë®¬ë ˆì´í„°</h3>
                    <p style="color:#666; font-size:13px; margin-bottom:20px;">ê° ë³‘ì› ë‹´ë‹¹ìê°€ ë˜ì–´ ìˆ˜ë½ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ì„¸ìš”.</p>
                    <div id="hos-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=84547021cbe941270f1fcb5becdf4912&libraries=services"></script>

    <script>
        var map, ps, currentLat = 37.566826, currentLon = 126.9786567;
        var hospitals = []; 
        var vital = { hr: 80, spo2: 98, sys: 120, dia: 80, rr: 16, bt: 36.5, glu: 100 };
        var isCriticalMode = false;
        var isArrhythmia = false;

        const MY_HOSPITAL_DB = ["ë¶€ì‚°ëŒ€í•™êµ", "ì–‘ì‚°ë¶€ì‚°", "ë™ì•„ëŒ€í•™êµ", "ê³ ì‹ ëŒ€í•™êµ", "ì¸ì œëŒ€", "ë°±ë³‘ì›", "ì¢‹ì€ê°•ì•ˆ", "ëŒ€ë™ë³‘ì›", "êµ¬í¬ì„±ì‹¬", "ì¹¨ë¡€", "í•œì¼", "ë´‰ìƒ", "ì„±ëª¨", "ë³´í›ˆ", "ì˜ë£Œì›", "ê¸°ë…"];

        window.onload = function() {
            initMap();
            startECG('ecg-canvas-1'); startECG('ecg-canvas-2');
            setInterval(simulationLoop, 1000); 
        };

        function initMap() {
            var mapContainer = document.getElementById('map');
            var mapOption = { center: new kakao.maps.LatLng(currentLat, currentLon), level: 7 }; 
            map = new kakao.maps.Map(mapContainer, mapOption);
            ps = new kakao.maps.services.Places();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    var loc = new kakao.maps.LatLng(currentLat, currentLon);
                    new kakao.maps.Marker({ map: map, position: loc });
                    map.setCenter(loc);
                });
            }
        }

        // [í•µì‹¬] KTAS 5ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜ íŠ¸ë¦¬ê±°
        function checkDeterioration() {
            var ktas = document.getElementById('p-ktas').value;
            if (ktas == "1") { 
                isCriticalMode = true; 
                alert("âš ï¸ [ì‹œë®¬ë ˆì´ì…˜] KTAS 1ë‹¨ê³„ (ì†Œìƒ): ì‹¬ì •ì§€ ìœ„ê¸° ìƒí™© ì—°ì¶œ");
                vital = { hr: 140, spo2: 85, sys: 70, dia: 40, rr: 30, bt: 36.0, glu: 60 };
            } else if (ktas == "2") {
                isCriticalMode = false; 
                vital = { hr: 110, spo2: 92, sys: 150, dia: 95, rr: 24, bt: 37.0, glu: 110 }; 
            } else if (ktas == "3") { 
                isCriticalMode = false;
                vital = { hr: 90, spo2: 96, sys: 130, dia: 85, rr: 18, bt: 36.8, glu: 100 }; 
            } else { // 4, 5ë‹¨ê³„ (ì•ˆì •)
                isCriticalMode = false;
                vital = { hr: 75, spo2: 99, sys: 110, dia: 70, rr: 14, bt: 36.5, glu: 95 }; 
            }
            runAIAlgorithm(); 
            updateUI();
        }

        function simulationLoop() {
            if (isCriticalMode) {
                vital.hr += Math.floor(Math.random() * 7) - 3; 
                vital.spo2 -= Math.floor(Math.random() * 2);
                vital.sys -= Math.floor(Math.random() * 3);
            } else {
                vital.hr += Math.floor(Math.random() * 3) - 1;
                vital.spo2 += Math.floor(Math.random() * 3) - 1;
            }
            if(vital.hr>190) vital.hr=190; if(vital.hr<30) vital.hr=30;
            if(vital.spo2>100) vital.spo2=100; if(vital.spo2<60) vital.spo2=60;
            if(vital.sys<50) vital.sys=50;

            isArrhythmia = (vital.hr > 130 || vital.hr < 50 || (isCriticalMode && Math.random() > 0.6));
            runAIAlgorithm(); updateUI();
        }

        function runAIAlgorithm() {
            var diag="ì •ìƒ", act="ê´€ì°°", cls="ai-normal";
            var ktas = document.getElementById('p-ktas').value;
            
            if (ktas == "4" || ktas == "5") { diag="ë¹„ì‘ê¸‰ / ê²½ì¦"; act="ì™¸ë˜ ì§„ë£Œ ê°€ëŠ¥"; cls="ai-safe"; }
            else if (isArrhythmia || ktas=="1") { diag="âš ï¸ ë¶€ì •ë§¥ / ì‹¬ì •ì§€ ì„ë°•"; act="ì¦‰ê°ì ì¸ ì†Œìƒìˆ  ë° CPR ì¤€ë¹„"; cls="ai-critical"; }
            else if (vital.spo2 < 90) { diag="ì €ì‚°ì†Œì¦ (Hypoxia)"; act="ì‚°ì†Œ íˆ¬ì—¬"; cls="ai-danger"; }
            else if (vital.sys < 90) { diag="ì‡¼í¬ ì˜ì‹¬"; act="ìˆ˜ì•¡ ê³µê¸‰"; cls="ai-danger"; }
            else if (ktas == "2") { diag="ê¸‰ì„± ì‹¬ê·¼ê²½ìƒ‰ ì˜ì‹¬"; act="PCI ê°€ëŠ¥ ë³‘ì› ì´ì†¡"; cls="ai-danger"; }
            else if (vital.rr > 30) { diag="ë¹ˆí˜¸í¡"; act="ê¸°ë„ í™•ë³´"; cls="ai-warn"; }
            
            var aiBox = document.getElementById('ai-box-ems');
            aiBox.className = "ai-box " + cls;
            document.getElementById('ai-diag-text').innerText = diag;
            document.getElementById('ai-action-text').innerText = "Rec: " + act;

            var hosText = document.getElementById('hos-ai-text');
            hosText.innerText = diag;
            if(cls.includes('crit')) hosText.style.color = '#d50000';
            else if(cls.includes('danger')) hosText.style.color = '#ff1744';
            else if(cls.includes('warn')) hosText.style.color = '#ff9800';
            else if(cls.includes('safe')) hosText.style.color = '#2196f3';
            else hosText.style.color = '#00e676';

            var alertDisplay = (isArrhythmia || ktas=="1") ? 'block' : 'none';
            document.getElementById('arrhythmia-alert').style.display = alertDisplay;
        }

        function updateUI() {
            var bpStr = vital.sys + "/" + vital.dia;
            updateVal('in-hr', vital.hr); updateVal('in-spo2', vital.spo2); updateVal('in-bp', bpStr);
            updateVal('m-hr', vital.hr); updateVal('m-spo2', vital.spo2); updateVal('m-bp', bpStr);
            updateVal('m-rr', vital.rr); updateVal('m-bt', vital.bt.toFixed(1)); updateVal('m-glu', vital.glu);
            updateVal('hos-hr', vital.hr); updateVal('hos-spo2', vital.spo2 + "%"); updateVal('hos-bp', bpStr);
            updateVal('hos-rr', vital.rr); updateVal('hos-bt', vital.bt.toFixed(1)); updateVal('hos-glu', vital.glu);
        }
        function updateVal(id, val) { if(document.getElementById(id)) { if(document.getElementById(id).tagName==='INPUT') document.getElementById(id).value=val; else document.getElementById(id).innerText=val; } }

        function searchHospitals() {
            var searchOptions = { location: new kakao.maps.LatLng(currentLat, currentLon), radius: 15000, sort: kakao.maps.services.SortBy.DISTANCE, size: 15 };
            ps.keywordSearch('ì‘ê¸‰ì‹¤', function(data, status) {
                if (status === kakao.maps.services.Status.OK) processHospitals(data);
                else {
                    ps.keywordSearch('ì¢…í•©ë³‘ì›', function(data2, status2) {
                        if (status2 === kakao.maps.services.Status.OK) processHospitals(data2);
                        else alert("ì£¼ë³€ 15km ë‚´ì— ì ì ˆí•œ ë³‘ì›ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }, searchOptions);
                }
            }, searchOptions);
        }

        function processHospitals(data) {
            var filtered = data.filter(item => {
                var n = item.place_name; var c = item.category_name;
                if (!c.includes('ì˜ë£Œ') && !c.includes('ë³‘ì›')) return false;
                if (n.includes('ë™ë¬¼') || n.includes('ì¹˜ê³¼') || n.includes('í•œë°©') || n.includes('ìš”ì–‘') || n.includes('ì•ˆê³¼') || n.includes('ì„±í˜•') || n.includes('í”¼ë¶€') || n.includes('ì¥ë¡€') || n.includes('ìˆ˜ë¦¬')) return false;
                return true;
            });
            hospitals = filtered.map(h => {
                var isVerified = MY_HOSPITAL_DB.some(dbName => h.place_name.includes(dbName));
                return { ...h, status: 'NONE', reason: '', isVerified: isVerified };
            });
            hospitals.sort((a, b) => b.isVerified - a.isVerified);
            renderEmsList();
            document.getElementById('btn-send').style.display = 'block';
        }

        function renderEmsList() {
            var html = "";
            hospitals.forEach((h, i) => {
                var badge = ""; var rowClass = ""; var time = Math.ceil(h.distance / 500) + "ë¶„";
                var verBadge = h.isVerified ? `<br><span class="badge bg-ver" style="background:#1565c0;">ğŸš‘ 30ë³‘ìƒ+</span>` : "";
                if (h.status === 'NONE') badge = `<span class="badge" style="background:#ddd; color:#333">ëŒ€ê¸°</span>`;
                else if (h.status === 'WAITING') badge = `<span class="badge bg-wait">ìˆ˜ì‹ ëŒ€ê¸°...</span>`;
                else if (h.status === 'ACCEPT') { badge = `<button class="btn-select" onclick="finalSelect(${i})">âœ… ìµœì¢…ì„ íƒ</button>`; rowClass = "accepted"; }
                else if (h.status === 'REJECT') { badge = `<span class="badge bg-reject">ê±°ì ˆë¨ (${h.reason || ''})</span>`; rowClass = "rejected"; }
                if(h.isVerified && rowClass === "") rowClass = "verified";
                html += `<div class="h-card ${rowClass}"><div style="flex:1;"><div style="font-weight:bold; font-size:13px;">${h.place_name}</div><div style="font-size:11px; color:#666;">ì•½ ${time} ì†Œìš” (${h.distance}m)</div>${verBadge}</div><div style="text-align:right;">${badge}</div></div>`;
            });
            document.getElementById('ems-list').innerHTML = html;
        }

        function confirmAndSend() {
            hospitals.forEach(h => { if(h.status === 'NONE') h.status = 'WAITING'; });
            renderEmsList();
            
            document.getElementById('hos-age-sex').innerText = document.getElementById('p-age').value + " / " + document.getElementById('p-gender').value;
            document.getElementById('hos-desc').innerText = document.getElementById('p-desc').value;
            document.getElementById('hos-icd').innerText = document.getElementById('p-icd').value;
            var ktasVal = document.getElementById('p-ktas').value;
            document.getElementById('hos-ktas').innerText = "Lv." + ktasVal + " (" + (ktasVal==1?"ì†Œìƒ":ktasVal==2?"ê¸´ê¸‰":ktasVal==3?"ì‘ê¸‰":ktasVal==4?"ì¤€ì‘ê¸‰":"ë¹„ì‘ê¸‰") + ")";
            document.getElementById('hos-avpu').innerText = document.getElementById('p-avpu').value;
            document.getElementById('hos-pain').innerText = document.getElementById('p-pain').value;
            document.getElementById('hos-note').innerText = document.getElementById('p-note').value;

            setTimeout(() => {
                var confirmSwitch = confirm("ìš”ì²­ ì „ì†¡ ì™„ë£Œ.\në³‘ì› ê´€ì œ ì‹œìŠ¤í…œìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
                if(confirmSwitch) goToHospitalView();
            }, 500);
        }

        function goToHospitalView() {
            renderHosList();
            document.getElementById('view-ems').style.display = 'none';
            document.getElementById('view-hos').style.display = 'block';
            requestAnimationFrame(() => { var c = document.getElementById('ecg-canvas-2'); c.width = c.offsetWidth; c.height = c.offsetHeight; });
        }

        function renderHosList() {
            var html = "";
            hospitals.forEach((h, i) => {
                var cardClass = "wait"; var actionHtml = "";
                if (h.status === 'WAITING') { actionHtml = `<div class="btn-row"><button class="btn-act act-yes" onclick="setDecision(${i}, 'ACCEPT')">ìˆ˜ë½</button><button class="btn-act act-no" onclick="setDecision(${i}, 'REJECT')">ê±°ì ˆ</button></div>`; } 
                else if (h.status === 'ACCEPT') { cardClass = "ok"; actionHtml = `<div style="text-align:center; color:#2e7d32; font-weight:bold; margin-top:10px;">âœ… ìˆ˜ë½ ì™„ë£Œ</div>`; } 
                else if (h.status === 'REJECT') { cardClass = "no"; actionHtml = `<div style="text-align:center; color:#c62828; font-weight:bold; margin-top:10px;">âŒ ê±°ì ˆë¨ (${h.reason})</div>`; }
                html += `<div class="hos-card-item ${cardClass}"><div style="font-weight:bold;">${h.place_name}</div><div style="font-size:12px; color:#666;">ê±°ë¦¬: ${h.distance}m</div>${actionHtml}</div>`;
            });
            document.getElementById('hos-grid').innerHTML = html;
        }

        // [í•µì‹¬ ë³µêµ¬] ê±°ì ˆ ì‚¬ìœ  ì…ë ¥ì°½ (Prompt)
        function setDecision(i, type) {
            if(type === 'ACCEPT') {
                hospitals[i].status = 'ACCEPT';
            } else { 
                var r = prompt("ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë³‘ìƒ ë¶€ì¡±, ìˆ˜ìˆ ì‹¤ ë¶ˆê°€)", "ë³‘ìƒ ë¶€ì¡±");
                if(r === null) return; // ì·¨ì†Œ ì‹œ ëŒì•„ê°
                hospitals[i].status = 'REJECT'; 
                hospitals[i].reason = r; 
            }
            renderHosList();
        }

        function backToEms() {
            renderEmsList();
            document.getElementById('view-hos').style.display = 'none';
            document.getElementById('view-ems').style.display = 'block';
        }

        function finalSelect(i) {
            var h = hospitals[i];
            var time = Math.ceil(h.distance/500);
            document.getElementById('final-msg').innerHTML = `<b>${h.place_name}</b>ë¡œ ì¶œë™í•©ë‹ˆë‹¤.<br>ì˜ˆìƒ ì†Œìš”ì‹œê°„: <b>${time}ë¶„</b>`;
            var naviUrl = `https://map.kakao.com/link/from/í˜„ìœ„ì¹˜,${currentLat},${currentLon}/to/${h.place_name},${h.y},${h.x}`;
            document.getElementById('navi-btn').onclick = function() { window.open(naviUrl, '_blank'); };
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('final-modal').style.display = 'block';
        }

        function startECG(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            function resize() { if(canvas.offsetWidth > 0) { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; } }
            window.addEventListener('resize', resize); resize(); 
            let x = 0; let points = [];
            function draw() {
                if (canvas.width > 0) {
                    ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = (isCriticalMode) ? '#ff1744' : '#00e676';
                    ctx.lineWidth = 2; ctx.beginPath();
                    if(points.length > 0) ctx.moveTo(points[0].x, points[0].y);
                    for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y);
                    ctx.stroke();
                    x+=2; if(x>canvas.width) { x=0; points=[]; }
                    let y = canvas.height/2;
                    var noise = (isCriticalMode) ? (Math.random()-0.5)*15 : 0;
                    if(x%60<10) y+=0; else if(x%60<15) y-=15+noise; else if(x%60<20) y+=10+noise; else if(x%60<30) y-=5; else y+=(Math.random()-0.5)*2;
                    points.push({x,y});
                }
                requestAnimationFrame(draw);
            }
            draw();
        }
    </script>
</body>
</html>